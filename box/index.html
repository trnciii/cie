<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>3D 階層構造 - コンテンツインタラクション演習</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "3D \u968e\u5c64\u69cb\u9020";
    var mkdocs_page_input_path = "box/README.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> コンテンツインタラクション演習</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/">環境構築</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">2D 線・円</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../lines/">直線</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../circle/">円</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../surface/">2D 相対移動</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">3D 階層構造</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_1">準備</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_2">プログラムの概要</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_3">立方体の描画</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_4">透視投影の設定</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">陰面消去</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_6">階層構造</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_7">階層構造とは</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_8">階層構造のつくりかた</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_9">課題</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1">課題1</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2">課題2</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../animation/">アニメーション</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../input/">マウスやキーボードによる入力</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../oneclick/">ワンクリックアクションの制作</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../timing/">タイミングアクション</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../trace/">軌跡を用いたインタラクション</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">コンテンツインタラクション演習</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>3D 階層構造</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="3d">3D 階層構造</h1>
<p>この資料は、従来版の第３回 - 3D 階層構造 に対応します。
<a href="https://github.com/trnciii/ciesample-box">このリポジトリ</a>からファイルをダウンロードしたら<code>sample.xcodeproj</code> を開き、実行できるか確認してください。</p>
<h2 id="_1">準備</h2>
<p>ここのコードをダウンロード、解凍してください。sample.xcodeproj を開き実行すると立方体が表示されることを確認してください。</p>
<p><em>macでよくあるのですが、実質的な画面の解像度がソフトウェア上の表示と異なっているために表示領域がおかしくなることがあります。その場合はウィンドウを移動させたり拡大/縮小すると正しい表示になります。</em></p>
<h2 id="_2">プログラムの概要</h2>
<p>このプログラムでは、これまでの平行投影法と違い <strong>透視投影法</strong> によって立方体を描画しています。
main.cpp の中にある関数<code>display()</code>の中で<code>makebox(1.0, 1.0, 1.0);</code>という関数が使用されており、これで以下の図のように幅, 高さ, 奥行がそれぞれ1である立方体を描画します。<br>
<img alt="" src="images/makebox.jpg" /></p>
<h3 id="_3">立方体の描画</h3>
<p>立方体を作る関数<code>makebox</code>は、box.hpp, box.cpp という2つのファイルの中に定義されています。<br>
<img alt="" src="images/im_files.png" /><br>
box.hpp の中を確認してみると、makebox の定義は　<code>makebox(width, height, length, type);</code> となっており、引数は順に <strong> <em>x方向の大きさ, y方向の大きさ, z方向の大きさ, 描画タイプ</em> </strong> を指定します。</p>
<h3 id="_4">透視投影の設定</h3>
<p>透視投影の設定は main.cpp の <code>reshape</code> 内で行っています。</p>
<pre><code class="language-cpp">void reshape(GLFWwindow* window, int w, int h)
{
    glViewport( 0, 0, (GLsizei)w, (GLsizei)h ); //ウィンドウ全体をビューポートにする
    glMatrixMode( GL_PROJECTION );
    glLoadIdentity(); //変換行列の初期化 

    gluPerspective(30.0, (double)w / (double)h, 1.0, 100.0);
    gluLookAt(
        3.0, 4.0, 5.0,    //どこから見てるか
        0.0, 0.0, 0.0,    //どこを見てるか
        0.0, 1.0, 0.0    //どの向きが上向きか
    );
}
</code></pre>
<p>gluPerspective();では透視投影法の視体積を設定しています。
括弧左から、視野角、縦横比、手前の座標、奥の座標を設定し、この範囲内にある物体を表示します。</p>
<p><code>gluPerspactive(th, w/h, near, far)</code>のとき次の図のようになります<br>
<img alt="" src="images/viewport2.jpg" /></p>
<p>関数<code>gluLookAt</code>は視点の設定をしています。
最初の３つのパラメータは視点の位置です。次の３つのパラメータは注視点の位置を表しています。このサンプルでは、カメラは位置(3.0, 4.0, 5.0)から原点(0.0, 0.0, 0.0) のほうを向いています。</p>
<p>最後の３つのパラメータで、どちらが「上」かということを決めており、この場合y軸が上になります。これによってカメラの傾きを決めています。</p>
<h2 id="_5">陰面消去</h2>
<p>物体の裏側が見えないことや、物体の一部がその他の物体にさえぎられて見えないような状況は実世界では当然のことです。しかし、CGではこれらをちゃんと設定しない限り、いわゆる”正しい”表示にはなりません。
この「本来見えない面を消す」ことを、隠面消去といいます。</p>
<p>このことを確認してみましょう。main.cpp の<code>display</code>関数を以下のように書き換えて、ポリゴンで立方体を表示するように切り替えましょう。</p>
<pre><code class="language-cpp">void display(void)
{
    glClear(GL_COLOR_BUFFER_BIT);

    glMatrixMode(GL_MODELVIEW);
    glLoadIdentity();

    // makebox(1.0,1.0,1.0);
    // ↓　ポリゴン表示に書き換え
    makebox(1.0, 1.0, 1.0, GL_POLYGON);
}
</code></pre>
<p>このプログラムを実行すると面の前後関係が正しく表示されない、以下のような状態になります。<br>
<img alt="" src="images/im_noDepth.png" /><bt></p>
<p>陰面消去をおこなうには、二つの関数<code>myinit</code>と<code>display</code>を以下のように書き換えます。</p>
<p>[ myinit関数 ]</p>
<pre><code class="language-cpp">void myinit(GLFWwindow** window)
{
    glfwInit();

    int w = 600;
    int h = 600;
    *window = glfwCreateWindow(w, h, &quot;surface&quot;, NULL, NULL);
    glClearColor(0, 0, 0, 1);

    reshape(*window, w, h);
    glEnable(GL_DEPTH_TEST); // 追加
}
</code></pre>
<p>[ display関数 ]</p>
<pre><code class="language-cpp">void display(void)
{
    // glClear(GL_COLOR_BUFFER_BIT);
    // ↓ GL_DEPTH_BUFFER_BIT　を追加
    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

    glMatrixMode(GL_MODELVIEW);
    glLoadIdentity();

    makebox(1.0,1.0,1.0,GL_POLYGON);
}
</code></pre>
<p>これで奥行を処理するデプスバッファを利用した描画を行うという指示ができました。正しく立方体を表示できたと思います。<br>
<img alt="" src="images/im_depth.png" /><br>
デプスバッファというのはそれぞれの画素ごとにポリゴンまでの距離(奥行, 深度)を記録しておくもので、この情報を利用して一番手前にあるポリゴンを表示することができます。</p>
<p>ウィンドウ初期化のときに <code>glEnable(GL_DEPTH_TEST)</code> を書くことで、以降の描画で奥行のチェックして画素を書き換えるという設定をしています。また、毎フレームの最初にデプスバッファを初期化するため、<code>glClear</code>関数に <code>GL_DEPTH_BUFFER_BIT</code> を与えています。</p>
<h2 id="_6">階層構造</h2>
<p>ボックスが綺麗に表示できるようになったところで、すこし複雑な表現をおこなってみましょう。このように複数のボックスがあるとします。<br>
<img alt="" src="images/boxes.jpg" /><br></p>
<h3 id="_7">階層構造とは</h3>
<p>ここで、Bのオブジェクトを動かすとAやCが一緒に動くようにするにはどうしたらいいでしょうか。</p>
<p>このような処理は、ひとまとまりのオブジェクトを一度に動かしたり（例：木を作ったとき、幹を移動させると、枝、葉が一緒に移動する→下図）、関節のある物体を作るとき（例：肩を回すと腕・肘・二の腕・指が一緒に回る）に必要になってきます。</p>
<table>
<thead>
<tr>
<th align="center">幹を動かせば木全体が動く(理想)</th>
<th align="center">幹を動かしても葉や枝が残ってしまう場合</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img alt="" src="images/tree_all.jpg" /></td>
<td align="center"><img alt="" src="images/tree_sep.jpg" /></td>
</tr>
</tbody>
</table>
<p>これは、階層構造をつくる＝オブジェクトの間に親子関係をつくることで実現できます。<br>
<img alt="" src="images/oyako_1.gif" /></p>
<p>例えば、AがBの親のとき、Aが動くとBもAとの位置関係を保ったままついてきます。<br>
<img alt="" src="images/oyako_2.gif" /></p>
<p>Aがその場で回転するとどうなるでしょう？BはAの周りをぐるぐると回ることになります。<br>
<img alt="" src="images/oyako_3.gif" /></p>
<p>一方Bがどんなに動いても、Aがついてきたりはしません。Bが拡大・縮小しても、その場で回転しても、Aには全く影響がありません。しかしやっぱり、散々Bが動いてAとの距離が相当に離れてしまっても、Aが移動するとその位置関係を保ったままBはついてきます。</p>
<h3 id="_8">階層構造のつくりかた</h3>
<p>OpenGLで階層構造を作るには、<code>glPopMatrix()</code>関数と<code>glPushMatrix()</code>関数を使います。 例として、<code>display()</code>で箱を出す部分を以下のように書き換えます。</p>
<pre><code class="language-cpp">glPushMatrix(); // 階層1
    glTranslated(0, 0, 0); // ★ 親に適用される
    makebox(1,1,1, GL_POLYGON); // A

    glPushMatrix(); // 階層2
        glTranslated(0, 1, 0); // ◆ 子の階層のみに適用される
        makebox(0.3,0.3,0.3, GL_POLYGON); // B
    glPopMatrix(); // 階層を戻る

glPopMatrix(); // 階層を戻る
</code></pre>
<p>最初の<code>glPushMatrix();</code>がひとつめの階層です。ここでボックスをひとつ描きます。このボックスをAとします。
そして、次の<code>glPushMatrix();</code>で階層を下りて、ボックスをひとつ描きます。このボックスをBとします。
次の行の<code>glPopMatrix();</code>は階層を戻るときに使います。これでボックスAを描いた階層と同じところに戻ります。
更に、もう一度<code>glPopMatrix();</code>をして、ひとつめの階層から脱出します。
ボックスAよりもボックスBのほうが下の階層にありますので、AはBの親（BはAの子）になります。</p>
<p>なお、インデントは階層をわかりやすくするためにつけています。</p>
<p>★の<code>glTranslated(0,0,0)</code>を引数を適当に変えてボックスを移動させてみましょう。ボックスBがボックスAに追従して移動します。<br>
<img src="images/im_t1L.png" width="300">
<img src="images/im_t1R.png" width="300"></p>
<p>一方で◆の<code>glTranslated(0,0,0)</code>を変更してみると、ボックスBだけを移動させることができます。<br>
<img src="images/im_t2.png" width="300"></p>
<p>回転や拡大/縮小などの操作に関しても同様のはたらきがあります。</p>
<h2 id="_9">課題</h2>
<h3 id="1">課題1</h3>
<p>前回までのプログラムを参考に、箱を増殖させて次のようなものを作ってみてください。<br>
<img src="images/boxes2.PNG" width="300">
<img src="images/boxes3.PNG" width="300">
<img src="images/boxes4.PNG" width="300"></p>
<!-- ### 課題2
下図のようにオブジェクトを配置してください。色や形は自由に変えていいです。<br>
![](images/boxes.jpg)<br> -->

<h3 id="2">課題2</h3>
<p>階層構造を使ってロボットを作って下さい。単純なものでもいいですし、人型のような複雑なものに挑戦してもいいです。胴体を動かすと脚や腕がついてくるといった操作が可能なものをつくり、さまざまな姿勢をとらせてください。<br>
<img src="images/boxes.jpg" width="300">
<img src="images/robo.GIF" width="300"></p>
<p>できた画像をキャプチャして、slackのほうに共有してくれると嬉しいです。</p>
<details>
    <summary>難しいという方へ...</summary>
    解答例をおいておきます。変形を行う関数`glTranslated`, `glRotated`などをいじってみて、階層構造のはたらきを理解しましょう。


<pre><code class="language-cpp">glPushMatrix();  //-- 胴
    glTranslated(0, -1.2, 0);
    makebox(1, 1, 1, GL_POLYGON);

    glPushMatrix();   // ----　頭
        glTranslated(0.0, 1.0, 0.0);
        makebox(1.0, 1.0, 1.0, GL_POLYGON);

        glPushMatrix(); // --- 左目
            glTranslated(0.25, 0.1, 0);
            glRotated(10, 0, 0, 1);
            glRotated(180, 0, 1, 0);
            makebox(0.3, 0.05, 1.2, GL_POLYGON);
        glPopMatrix();

        glPushMatrix(); // --- 左目
            glTranslated(-0.25, 0.1, 0);
            glRotated(-10, 0, 0, 1);
            glRotated(180, 0, 1, 0);
            makebox(0.3, 0.05, 1.2, GL_POLYGON);
        glPopMatrix();

        glPushMatrix(); // --- 口
            glTranslated(0, -0.2, 0);
            glRotated( 180, 0, 1, 0);
            makebox(0.7, 0.05, 1.2, GL_POLYGON);
        glPopMatrix();
    glPopMatrix(); // 頭おわり


    glPushMatrix();  //-- 右足
        glTranslated(-0.35, -1.2, 0);
        makebox(0.3, 1, 1, GL_POLYGON);
    glPopMatrix();


    glPushMatrix();  //-- 左足
        glTranslated( 0.35, -1.2, 0);
        makebox(0.3, 1, 1, GL_POLYGON);
    glPopMatrix();


    glPushMatrix();  //-- 右腕
        glTranslated(-1.2, 0.35, 0);
        makebox(1, 0.3, 1, GL_POLYGON);
    glPopMatrix();


    glPushMatrix();  //-- 左腕
        glTranslated( 1.2, 0.35, 0);
        makebox(1, 0.3, 1, GL_POLYGON);
    glPopMatrix();

glPopMatrix();

</code></pre>

</details>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../animation/" class="btn btn-neutral float-right" title="アニメーション">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../surface/" class="btn btn-neutral" title="2D 相対移動"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../surface/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../animation/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
