<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>タイミングアクション - コンテンツインタラクション演習</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u30bf\u30a4\u30df\u30f3\u30b0\u30a2\u30af\u30b7\u30e7\u30f3";
    var mkdocs_page_input_path = "timing/README.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> コンテンツインタラクション演習</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/">環境構築</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">2D 線・円</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../lines/">直線</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../circle/">円</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../surface/">2D 相対移動</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../box/">3D 階層構造</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../animation/">アニメーション</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../input/">マウスやキーボードによる入力</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../oneclick/">ワンクリックアクションの制作</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">タイミングアクション</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">プログラム解説</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">頭の投下</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_4">考えかた</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_5">実装</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_6">頭と胴体の交差判定</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_7">考え方</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_8">実装</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_9">画像の書き出し</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_10">画像を受け取る配列の用意</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_11">画面のキャプチャ</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_12">画像の保存</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_13">課題</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1">課題1</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2">課題2</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../trace/">軌跡を用いたインタラクション</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">コンテンツインタラクション演習</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>タイミングアクション</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="_1">タイミングアクションの制作</h1>
<p>この資料は、従来版の後半第3回 -   タイミングアクションの制作 に対応します。
<a href="https://github.com/trnciii/ciesample-timing">このリポジトリ</a>からファイルをダウンロードしたら<code>sample.xcodeproj</code> を開いてください。
ダウンロードした状態のプログラムは、右から胴体が10個流れてくるというものです。</p>
<p>この章ではロボット工場でロボットの頭を取り付けるという簡単なゲームを作成します。 ここではタイミング要素をインタラクションに取り入れ、キーを押すとロボットの頭が落ちるようにします。 頭が体の上に乗るとロボット製作成功というルールにします。
今回は以下の順でプログラムを完成させていきます。</p>
<ol>
<li>キーボード操作による頭の投下</li>
<li>胴体との交差判定と動きのコントロール</li>
</ol>
<p>また、最後に画像を書き出す方法も紹介します。</p>
<p><img alt="" src="images/tiser.gif" /></p>
<h3 id="_2">プログラム解説</h3>
<p>今回使うロボットはすでに<a href="../surface/#ディスプレイリスト">ディスプレイリスト</a>として定義してあり、<code>glCallList( ROBO_BODY )</code>, <code>glCallList( ROBO_HEAD )</code>とすることでそれぞれロボットの体と頭をよびだすことができます。</p>
<p>動きをコントロールするための変数として以下がグローバルに定義されています。</p>
<pre><code class="language-cpp">// 各ロボットの体のx座標
double body_pos_x[MAX_ROBO];

// 各ロボットの頭の座標
double head_pos_x[MAX_ROBO];
double head_pos_y[MAX_ROBO];
</code></pre>
<p>また<code>myinit</code>では各座標の初期化を、<code>display</code>関数では胴体の位置更新と描画をおこなっています。</p>
<p>[ void myinit(GLFWwindow** window) ]</p>
<pre><code class="language-cpp">// ...

    //座標の初期化
    for(int i = 0; i &lt; MAX_ROBO; i++){
        body_pos_x[i] = i*4+8;

        head_pos_x[i] = 0.0;
        head_pos_y[i] = 0.0;
        used[i] = false;
        complete[i] = false;
    }

// ...

</code></pre>
<p>[ void display(int frame) ]</p>
<pre><code class="language-cpp">// ...

    // 各ロボット位置の更新
    for(int i = 0; i &lt; MAX_ROBO; i++){

        body_pos_x[i] += -0.2;

        // 体の描画
        glTranslated( body_pos_x[i], 0.0, 0.0 );
        glCallList( ROBO_BODY );
        glLoadIdentity();

        // 頭の描画
        glTranslated( head_pos_x[i], head_pos_y[i], 0.0 );
        glCallList( ROBO_HEAD );
        glLoadIdentity();
    }

// ...
</code></pre>
<p>以上が配布プログラムの要点です。</p>
<h2 id="_3">頭の投下</h2>
<p>適当なキーを押したら頭が落下するようにします。以下、"↓"を押すことに決めて説明をします。</p>
<h3 id="_4">考えかた</h3>
<p>それぞれの頭部はキーを押すごとに一つづつ落下していきます。
いま何個の頭まで落下しているか数えておき、その範囲だけ動かすようにします。</p>
<h3 id="_5">実装</h3>
<p>グローバル変数として以下のように<code>used = 0</code>を追加してください。</p>
<pre><code class="language-cpp">//
// ロボットの座標などの配列
//
// 追加. 何個めの頭まで落下したか
int used = 0;
</code></pre>
<p><code>used</code>はキーを押すごとに増加します。ただし、用意した配列外の数にならないようにします。</p>
<pre><code class="language-cpp">void KeyFunc(GLFWwindow* window, int key, int scancode, int action, int mods)
{
    // ↓
    if( key == GLFW_KEY_DOWN &amp;&amp; action == GLFW_PRESS )
    {
        printf(&quot;↓\n&quot;);
        if(used&lt;MAX_ROBO) used++; // 追記
    }
}
</code></pre>
<p>最後に、配列の <strong>[0, used)</strong> の範囲で頭を落下させます。
<code>display</code>の中で頭の座標を更新します。</p>
<pre><code class="language-cpp">void display(int frame){
    // ...

    // 追記分. 各頭部の更新
    for(int i=0; i&lt;used; i++){
        head_pos_y[i] -= 0.8;
    }

    // 各胴体位置の更新と描画
    for(int i = 0; i &lt; MAX_ROBO; i++){

        body_pos_x[i] += -0.2;
        // ...
</code></pre>
<p>以上で、全部で10個ある頭が一個ずつ落下していくという処理ができました。</p>
<h2 id="_6">頭と胴体の交差判定</h2>
<p>落下する頭が胴体に当たると合体するようにします。
交差判定と、その結果による動きの切り替えを実装します。
動きの切り替えは課題とします。</p>
<h3 id="_7">考え方</h3>
<p>頭がいずれかの胴体と交差したとき、落下をやめて左方向に動くようにします。
それぞれの頭が交差したかの値を記録する配列を用意し、交差判定とそれをもとにした動きの切り替えをおこないます。</p>
<h3 id="_8">実装</h3>
<p>まず頭が胴体に当たったかのフラグとなるグローバル変数を用意し、初期化します。</p>
<pre><code class="language-cpp">//
// ロボットの座標などの配列
//
bool hit[MAX_ROBO];

// ...

void myinit(GLFWwindow** window)
{
    // ...

    //変数の初期化
    for(int i = 0; i &lt; MAX_ROBO; i++){
        body_pos_x[i] = i*4+8;

        head_pos_x[i] = 0.0;
        head_pos_y[i] = 0.0;

        hit[i] = false;
    }
}
</code></pre>
<p>[0, used) の範囲の頭について、交差判定をおこないます。
今回は落下位置が画面中央と決まっているので、以下の条件で判定できます。</p>
<ol>
<li>胴体が左右の真ん中にあるか</li>
<li>頭が適当な高さにあるか ( y = -6 で丁度いい位置らしい )</li>
</ol>
<p>これらの判定をすべての胴体に対しておこないます。</p>
<pre><code class="language-cpp">void display(int frame)
{
    // ...

    // 交差判定
    for(int head = 0; head &lt; used; head++)
    {
        for(int body = 0; body &lt; MAX_ROBO; body++)
        {
            // 条件の判定
            bool flag_y = (-7 &lt; head_pos_y[head] ) &amp;&amp; ( head_pos_y[head] &lt; -5 );
            bool flag_x = (-1 &lt; body_pos_x[body] ) &amp;&amp; ( body_pos_x[body] &lt;  1 );

            // あてはまる場合にフラグ(hit)を更新
            if( flag_y &amp;&amp; flag_x )
            {
                hit[head] = true;
            }
        }
    }

    // 各頭部の更新
    for(int i=0; i&lt;used; i++){
        // ここを書き換える
    }

    // 各胴体位置の更新と描画
    for(int i = 0; i &lt; MAX_ROBO; i++){
        // ...
    }
</code></pre>
<p>これで、各頭が胴体と合体したかどうかの配列<code>hit</code>が得られました。
この結果を利用して実際に頭が胴体と一緒に動くようにしてください。</p>
<h2 id="_9">画像の書き出し</h2>
<p>まえに質問してきた人がいたので、OpenGLで描画している画面を画像として書き出す方法を紹介します。
public domain で公開されている<a href="https://github.com/nothings/stb">stb</a>というライブラリに含まれる、<a href="https://github.com/nothings/stb/blob/master/stb_image_write.h">stb_image_write.h</a>というヘッダファイルを使います。（ヘッダファイルは既に配布したプログラムにすでに含めています。）
次のコードで、スペースを押すと画面全体をキャプチャできます。</p>
<pre><code class="language-cpp">void KeyFunc(GLFWwindow* window, int key, int scancode, int action, int mods)
{
    // ...

    // スペースキー
    if( key == GLFW_KEY_SPACE &amp;&amp; action == GLFW_PRESS )
    {
        printf(&quot;SPACE\n&quot;);

        int w,h;
        glfwGetFramebufferSize(window, &amp;w, &amp;h); // 画面サイズの取得

        unsigned int* image = new unsigned int[w*h]; // ピクセルの配列を用意

        glReadPixels(0, 0, w, h, GL_RGB, GL_UNSIGNED_BYTE, image); // キャプチャ

        stbi_write_png(&quot;/適当な場所/capture.png&quot;, w, h, 3, image, 3*w); // 書き出し

        delete[] image;
    }

    // ...
}
</code></pre>
<p>以上の部分で<strong>画像を受け取る配列の用意</strong>、<strong>画面のキャプチャ</strong>、<strong>画像の保存</strong>をおこなっています。</p>
<p>実はこのままだと画像の上下が逆になるのですが、今回はこのまま進めます。
すごく余裕がある人は、正しい向きで書き出されるように修正してみるとよい練習になると思います。</p>
<h3 id="_10">画像を受け取る配列の用意</h3>
<p>まず<code>glfwGetFramebufferSize</code>を使って画面の大きさを取得します。<code>w, h</code>に幅と高さの値がはいります。
つぎにピクセルの値を保存する配列を用意します。
型は<code>unsigned int</code>で、<code>new</code>を用いてピクセル数分の配列をつくります。</p>
<h3 id="_11">画面のキャプチャ</h3>
<p><code>glReadPixels</code>を利用します。
引数は、取得したい画像の ( 原点x, 原点y, 幅, 高さ, 色, 型, 結果をうけとる配列 ) です。
原点と幅については以下のようになっていて、ウィンドウ全体に対して青い部分がキャプチャされます。
画面全体を取得するために、原点と幅、高さをウィンドウと揃えました。</p>
<p>詳しくは<a href="https://www.khronos.org/registry/OpenGL-Refpages/gl2.1/xhtml/glReadPixels.xml">こちら</a></p>
<p><img src="images/capture.png" width="600"></p>
<h3 id="_12">画像の保存</h3>
<p><code>stbi_write_png</code>を利用し、png画像を保存します。
引数は、( ファイル名, 幅, 高さ, 色の数, 画像の配列, 1行の長さ(色数×幅) ) です。
保存場所は各自で書き換えてください。</p>
<p>使い方の詳しい説明はソースファイルに書いてあります。(配布したサンプルまたは<a href="https://github.com/nothings/stb/blob/master/stb_image_write.h">ここ</a>)</p>
<h2 id="_13">課題</h2>
<h3 id="1">課題1</h3>
<p>各頭部の更新処理 (上のコード参照) を書き換えて最初に示したようなゲームを完成させてください。
以下の条件を想定しますが、成り立っていれば数値を変えてもいいです。</p>
<ul>
<li>胴体に当たった頭部がその胴体と一緒に動くようにしてください。</li>
<li>胴体はx方向に -0.2 の速度で動いています。</li>
<li>首の高さは y = -6 です</li>
</ul>
<h3 id="2">課題2</h3>
<p>以下のことをおこなってください。</p>
<ul>
<li>見た目の面白さのため、落下の仕方や左右の動きを変更してください。</li>
<li>ゲーム性を高めるため、点数の計算やゲームオーバー判定、難易度の調整などをおこなってください。</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../trace/" class="btn btn-neutral float-right" title="軌跡を用いたインタラクション">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../oneclick/" class="btn btn-neutral" title="ワンクリックアクションの制作"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../oneclick/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../trace/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
